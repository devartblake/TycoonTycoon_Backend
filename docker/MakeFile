.PHONY: help up up-dev up-prod down restart logs ps clean health migrate shell-postgres shell-mongo shell-redis api-logs migration-logs

# Docker Compose file paths
COMPOSE = docker compose -f docker/compose.yml
COMPOSE_DEV = docker compose -f docker/compose.yml -f docker/compose.dev.yml --profile dev
COMPOSE_PROD = docker compose -f docker/compose.yml -f docker/compose.prod.yml

# Default target
help:
	@echo "Tycoon Backend - Docker Commands"
	@echo ""
	@echo "Development:"
	@echo "  make up                 Start all services"
	@echo "  make up-dev             Start all services + dev tools (pgAdmin, Kibana, etc.)"
	@echo "  make down               Stop all services"
	@echo "  make restart            Restart all services"
	@echo "  make logs               View all logs (tail -f)"
	@echo "  make ps                 List running services"
	@echo ""
	@echo "Database:"
	@echo "  make migrate            Run database migrations"
	@echo "  make shell-postgres     Open PostgreSQL shell"
	@echo "  make shell-mongo        Open MongoDB shell"
	@echo "  make shell-redis        Open Redis CLI"
	@echo ""
	@echo "Monitoring:"
	@echo "  make health             Check health of all services"
	@echo "  make api-logs           View backend API logs"
	@echo "  make migration-logs     View migration service logs"
	@echo ""
	@echo "Maintenance:"
	@echo "  make clean              Stop and remove all volumes (âš ï¸ DELETES DATA)"
	@echo "  make rebuild            Rebuild Docker images"
	@echo "  make rebuild-api        Rebuild API image only"
	@echo "  make rebuild-migration  Rebuild migration image only"
	@echo ""
	@echo "Production:"
	@echo "  make up-prod            Start in production mode"

# ===================================
# Development Commands
# ===================================

up:
	$(COMPOSE) up -d

up-dev:
	$(COMPOSE_DEV) up -d

up-prod:
	$(COMPOSE_PROD) up -d

down:
	$(COMPOSE) down

restart:
	$(COMPOSE) restart

logs:
	$(COMPOSE) logs -f

ps:
	$(COMPOSE) ps

# ===================================
# Database Commands
# ===================================

migrate:
	@echo "Starting databases..."
	$(COMPOSE) up -d postgres mongodb redis elasticsearch
	@echo "Waiting for databases to be healthy..."
	@sleep 10
	@echo "Running migrations..."
	$(COMPOSE) run --rm migration
	@echo "âœ… Migrations complete!"

shell-postgres:
	@$(COMPOSE) exec postgres psql -U $${POSTGRES_USER:-tycoon_user} -d $${POSTGRES_DB:-tycoon_db}

shell-mongo:
	@$(COMPOSE) exec mongodb mongosh -u $${MONGO_INITDB_ROOT_USERNAME:-tycoon_admin} -p $${MONGO_INITDB_ROOT_PASSWORD:-tycoon_mongo_password_123}

shell-redis:
	@$(COMPOSE) exec redis redis-cli -a "$${REDIS_PASSWORD:-tycoon_redis_password_123}"

# ===================================
# Monitoring Commands
# ===================================

health:
	@echo "=== Service Health Checks ==="
	@echo ""
	@echo "PostgreSQL:"
	@$(COMPOSE) exec -T postgres pg_isready -U $${POSTGRES_USER:-tycoon_user} -d $${POSTGRES_DB:-tycoon_db} || echo "  âŒ Not ready"
	@echo ""
	@echo "MongoDB:"
	@$(COMPOSE) exec -T mongodb mongosh --quiet --eval "db.adminCommand('ping')" || echo "  âŒ Not ready"
	@echo ""
	@echo "Redis:"
	@$(COMPOSE) exec -T redis redis-cli -a "$${REDIS_PASSWORD:-tycoon_redis_password_123}" ping || echo "  âŒ Not ready"
	@echo ""
	@echo "Elasticsearch:"
	@curl -fsS -u elastic:$${ELASTIC_PASSWORD:-tycoon_elastic_password_123} http://localhost:$${ELASTICSEARCH_PORT:-9200}/_cluster/health?pretty 2>/dev/null | grep -q '"status"' && echo "  âœ… Healthy" || echo "  âŒ Not ready"
	@echo ""
	@echo "Backend API:"
	@curl -fsS http://localhost:$${BACKEND_HTTP_PORT:-5000}/healthz 2>/dev/null && echo "  âœ… Healthy" || echo "  âŒ Not ready"

api-logs:
	$(COMPOSE) logs -f backend-api

migration-logs:
	$(COMPOSE) logs migration

# ===================================
# Maintenance Commands
# ===================================

clean:
	@echo "âš ï¸  This will DELETE all data (volumes). Are you sure? [y/N]"
	@read ans && [ $${ans:-N} = y ]
	$(COMPOSE) down -v --remove-orphans
	@echo "âœ… Cleanup complete"

rebuild:
	@echo "Rebuilding all images..."
	$(COMPOSE) build --no-cache
	@echo "âœ… Rebuild complete"

rebuild-api:
	@echo "Rebuilding API image..."
	$(COMPOSE) build --no-cache backend-api
	@echo "âœ… API rebuild complete"

rebuild-migration:
	@echo "Rebuilding migration image..."
	$(COMPOSE) build --no-cache migration
	@echo "âœ… Migration rebuild complete"

# ===================================
# Advanced Commands
# ===================================

.PHONY: backup-postgres backup-mongo restore-postgres restore-mongo

backup-postgres:
	@mkdir -p backups
	@echo "Backing up PostgreSQL..."
	@$(COMPOSE) exec -T postgres pg_dump -U $${POSTGRES_USER:-tycoon_user} $${POSTGRES_DB:-tycoon_db} > backups/postgres_$$(date +%Y%m%d_%H%M%S).sql
	@echo "âœ… PostgreSQL backup complete: backups/"

backup-mongo:
	@mkdir -p backups
	@echo "Backing up MongoDB..."
	@$(COMPOSE) exec mongodb mongodump --username=$${MONGO_INITDB_ROOT_USERNAME:-tycoon_admin} --password=$${MONGO_INITDB_ROOT_PASSWORD:-tycoon_mongo_password_123} --out=/tmp/backup
	@docker cp tycoon_mongodb:/tmp/backup backups/mongodb_$$(date +%Y%m%d_%H%M%S)
	@echo "âœ… MongoDB backup complete: backups/"

restore-postgres:
	@if [ -z "$(FILE)" ]; then echo "Usage: make restore-postgres FILE=backup.sql"; exit 1; fi
	@echo "Restoring PostgreSQL from $(FILE)..."
	@$(COMPOSE) exec -T postgres psql -U $${POSTGRES_USER:-tycoon_user} $${POSTGRES_DB:-tycoon_db} < $(FILE)
	@echo "âœ… PostgreSQL restore complete"

restore-mongo:
	@if [ -z "$(DIR)" ]; then echo "Usage: make restore-mongo DIR=backup_dir"; exit 1; fi
	@echo "Restoring MongoDB from $(DIR)..."
	@docker cp $(DIR) tycoon_mongodb:/tmp/restore
	@$(COMPOSE) exec mongodb mongorestore --username=$${MONGO_INITDB_ROOT_USERNAME:-tycoon_admin} --password=$${MONGO_INITDB_ROOT_PASSWORD:-tycoon_mongo_password_123} /tmp/restore
	@echo "âœ… MongoDB restore complete"

# ===================================
# Quick Start Commands
# ===================================

.PHONY: quick-start quick-dev quick-prod

quick-start:
	@echo "ðŸš€ Starting Tycoon Backend..."
	@make up
	@echo ""
	@echo "Waiting for services to be healthy..."
	@sleep 15
	@echo ""
	@make health
	@echo ""
	@echo "âœ… Tycoon Backend is ready!"
	@echo ""
	@echo "Access:"
	@echo "  API: http://localhost:5000"
	@echo "  Swagger: http://localhost:5000/swagger"
	@echo "  Hangfire: http://localhost:5000/hangfire"

quick-dev:
	@echo "ðŸš€ Starting Tycoon Backend (Development Mode)..."
	@make up-dev
	@echo ""
	@echo "Waiting for services to be healthy..."
	@sleep 15
	@echo ""
	@make health
	@echo ""
	@echo "âœ… Tycoon Backend is ready!"
	@echo ""
	@echo "Access:"
	@echo "  API: http://localhost:5000"
	@echo "  Swagger: http://localhost:5000/swagger"
	@echo "  Hangfire: http://localhost:5000/hangfire"
	@echo "  pgAdmin: http://localhost:5050"
	@echo "  Mongo Express: http://localhost:8081"
	@echo "  Kibana: http://localhost:5601"

quick-prod:
	@echo "ðŸš€ Starting Tycoon Backend (Production Mode)..."
	@make up-prod
	@echo ""
	@echo "Waiting for services to be healthy..."
	@sleep 20
	@echo ""
	@echo "âœ… Tycoon Backend is ready!"
	@echo ""
	@echo "Access:"
	@echo "  API: http://localhost:5000"
