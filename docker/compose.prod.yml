version: "3.8"

# Production overrides:

# - No dev UIs

# - Only expose API to host (infra stays private inside the compose network)

# - Tighter defaults for resources and logging

services:
postgres:
# In prod, avoid exposing DB to the host unless required
ports: []
environment:
# Example: enforce stronger defaults if not provided
POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required in prod}"
logging:
driver: "json-file"
options:
max-size: "10m"
max-file: "5"

mongodb:
  ports: []
  environment:
  MONGO_INITDB_ROOT_PASSWORD: "${MONGO_INITDB_ROOT_PASSWORD:?MONGO_INITDB_ROOT_PASSWORD is required in prod}"
  MONGO_APP_PASSWORD: "${MONGO_APP_PASSWORD:?MONGO_APP_PASSWORD is required in prod}"
  logging:
  driver: "json-file"
  options:
  max-size: "10m"
  max-file: "5"

redis:
  ports: []
# In prod, require explicit password (already enforced in command)
  logging:
  driver: "json-file"
  options:
  max-size: "10m"
  max-file: "5"

elasticsearch:
  ports: []
  environment:
ELASTIC_PASSWORD: "${ELASTIC_PASSWORD:?ELASTIC_PASSWORD is required in prod}"
# A conservative default; tune based on your host
ES_JAVA_OPTS: "${ES_JAVA_OPTS:--Xms1g -Xmx1g}"
ulimits:
memlock:
  soft: -1
  hard: -1
  logging:
  driver: "json-file"
  options:
  max-size: "10m"
  max-file: "5"

# Explicitly disable dev-only tools in prod

kibana:
profiles: ["disabled"]

pgadmin:
  profiles: ["disabled"]

mongo-express:
  profiles: ["disabled"]

# Optional: run the API in prod via Docker (Option B)

# This assumes you have uncommented backend-api in compose.yml OR you can enable it here.

# Recommended: keep it enabled in prod and do not run the API on-host.

#

# If backend-api is commented out in compose.yml, you can copy the backend-api service

# block into compose.yml and leave it disabled by default, then run prod with --profile.

#

# If backend-api already exists in compose.yml (recommended), prod only overrides it:

backend-api:
# Expose only the API
  ports:
  - "${BACKEND_HTTP_PORT:-5000}:5000"
  environment:
ASPNETCORE_ENVIRONMENT: "${ASPNETCORE_ENVIRONMENT:-Production}"
ASPNETCORE_URLS: "http://+:5000"
depends_on:
  postgres:
  condition: service_healthy
  mongodb:
    condition: service_healthy
  redis:
    condition: service_healthy
  elasticsearch:
    condition: service_healthy
  restart: unless-stopped
  logging:
  driver: "json-file"
  options:
  max-size: "10m"
  max-file: "5"

# Migrations should be an explicit step in prod (run once per deploy)

migration:
  environment:
  ASPNETCORE_ENVIRONMENT: "${ASPNETCORE_ENVIRONMENT:-Production}"
  restart: "no"
  logging:
  driver: "json-file"
  options:
  max-size: "10m"
  max-file: "3"
